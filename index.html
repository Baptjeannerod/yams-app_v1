<!DOCTYPE html>
<html lang="fr" data-theme="light" data-scale="1" data-dense="0" style="--col-min:150px;">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="manifest.webmanifest?v=11.1">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Yam’s — Scores & Classement</title>
<style>
  :root{
    --radius:12px;
    --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#475569;
    --border: rgba(15,23,42,.22);
    --row-alt: rgba(2,6,23,.05);
    --accent-soft: rgba(59,130,246,.12); --accent-border: rgba(59,130,246,.35);
    --danger: rgba(239,68,68,.2); --danger-border: rgba(239,68,68,.45);
    --success: rgba(34,197,94,.2); --success-border: rgba(34,197,94,.45);
    --sticky: color-mix(in oklab, var(--panel) 92%, transparent);
    --hl: rgba(250,204,21,.18); --hl-border: rgba(250,204,21,.5);
  }
  html[data-theme="dark"]{
    --bg:#0f172a; --panel:#0b1220; --text:#e2e8f0; --muted:#94a3b8;
    --border: rgba(148,163,184,.35);
    --row-alt: rgba(2,6,23,.35);
    --accent-soft: rgba(59,130,246,.15); --accent-border: rgba(59,130,246,.35);
    --danger: rgba(239,68,68,.22); --danger-border: rgba(239,68,68,.55);
    --success: rgba(34,197,94,.22); --success-border: rgba(34,197,94,.55);
    --sticky: color-mix(in oklab, var(--panel) 96%, transparent);
    --hl: rgba(250,204,21,.12); --hl-border: rgba(250,204,21,.45);
  }
  html { font-size: calc(16px * var(--scale, 1)); }
  html[data-scale="0.9"]{ --scale: .9; }
  html[data-scale="1"]{ --scale: 1; }
  html[data-scale="1.1"]{ --scale: 1.1; }

  html[data-dense="0"]{ --dense-font: 1rem; --dense-pad: 8px; --input-w: 5.2rem; }
  html[data-dense="1"]{ --dense-font: .9rem; --dense-pad: 6px; --input-w: 4.6rem; }
  html[data-dense="2"]{ --dense-font: .8rem; --dense-pad: 4px; --input-w: 4.0rem; }

  html, body { height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, Helvetica, Arial;
  }
  header { position: sticky; top: 0; z-index: 20; backdrop-filter: saturate(180%) blur(6px);
    padding: max(12px, env(safe-area-inset-top)) 16px 12px 16px; background: color-mix(in oklab, var(--panel) 85%, transparent); border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
  }
  h1{ font-size: clamp(20px, 2.6vw, 28px); margin:0; line-height:1.2; }
  .sub{ color:var(--muted); font-size: .95rem; }
  .spacer{ flex:1; }

  main{ padding: 16px; display:grid; gap:16px; }

  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, input, select{
    background:#fff; color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:10px; outline:none;
    min-height:40px; font-size:1rem; cursor:pointer;
  }
  html[data-theme="dark"] button, html[data-theme="dark"] input, html[data-theme="dark"] select { background:#111827; }

  .leaderboard { background: var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px; display:grid; gap:10px; }
  .lb-title{ display:flex; align-items:center; gap:8px; cursor:pointer; }
  .lb-title .hint{ color:var(--muted); font-size:.9rem; }
  .lb-grid{ display:grid; grid-template-columns: 1fr; gap:8px; }
  .lb-block{ border:1px solid var(--border); border-radius:12px; padding:8px; }
  .lb-block.highlight{ background: var(--hl); border-color: var(--hl-border); }
  .lb-block h4{ margin:0 0 6px 0; font-size:1rem; }
  .rank-pill{ padding:6px 10px; border:1px solid var(--accent-border); border-radius:999px; background:var(--accent-soft); font-weight:700; display:inline-block; margin:2px 6px 2px 0; }
  .muted { color: var(--muted); }

  .table-wrap{ background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); overflow: auto; }
  table { width:100%; border-collapse: separate; border-spacing: 0; min-width: 760px; }
  thead th{ position: sticky; top:0; z-index: 5; background: var(--sticky); border-bottom: 1px solid var(--border); text-align: center; }
  th, td{ padding: var(--dense-pad) 6px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); background-clip: padding-box; font-size: var(--dense-font); }
  th:last-child, td:last-child{ border-right: none; }
  tbody tr:nth-child(odd){ background: var(--row-alt); }
  th.cat, td.cat{ width: 220px; text-align: left; }
  th.player{ min-width: var(--col-min); }
  .player-head{ display:flex; align-items:center; justify-content:center; gap:6px; flex-wrap:wrap; }
  .player-head .name{ font-weight:700; text-align:center; }
  .player-head button{ min-height:30px; padding:6px 8px; font-size:.9rem; }
  .cell{ text-align: center; }
  .cell input[type="number"]{ width: var(--input-w); text-align:center; min-height:34px; margin: 0 auto; display:block; }
  .cell input.is-empty{ background: var(--danger); border-color: var(--danger-border); }
  .cell input.is-filled{ background: var(--success); border-color: var(--success-border); }
  th:first-child, td:first-child{ position: sticky; left: 0; z-index: 4; background: var(--sticky); }
  tr.last-row td{ position: sticky; bottom: 0; background: var(--sticky); z-index: 3; }
  .subtotal{ color: var(--muted); font-weight: 600; text-align:center; }
  .total{ font-weight:800; text-align:center; }

  .settings-btn{ margin-left:auto; width:40px; height:40px; display:grid; place-items:center; border-radius:10px; }

  .backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; z-index: 90; }
  .backdrop.open{ display:block; }
  .modal{ position: fixed; z-index: 100; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(760px, calc(100vw - 32px)); background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 24px 64px rgba(0,0,0,.25); display:none; }
  .modal.open{ display:block; }
  .modal h3{ margin: 0 0 12px 0; font-size: 1.15rem; }
  .section{ margin-top: 8px; }
  .section h4{ margin: 8px 0; font-size: 1rem; }
  .radio-row, .row{ display:flex; align-items:center; gap:10px; padding:8px 0; flex-wrap: wrap; }
  .modal .actions{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 6px; }
  .modal .close-line{ display:flex; justify-content:flex-end; }
  .ghost-btn{ background: transparent; }
  .hidden-input{ display:none; }
  .danger-btn{ border-color: var(--danger-border); color: #7f1d1d; }

  /* Error overlay */
  #errOverlay{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.65); z-index:9999; color:white; }
  #errBox{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(720px, calc(100vw - 32px)); background:#111827; border:1px solid #ef4444; border-radius:14px; padding:16px; }
  #errBox pre{ white-space:pre-wrap; word-break:break-word; background:#0b1220; padding:10px; border-radius:8px; max-height:40vh; overflow:auto; }
  #errActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }

</style>
</head>
<body>
  <div id="errOverlay">
    <div id="errBox">
      <h3>Oups — une erreur JavaScript a été détectée</h3>
      <p>Tu peux vider le cache, copier le détail, puis recharger.</p>
      <pre id="errText"></pre>
      <div id="errActions">
        <button id="btnCopy">Copier l’erreur</button>
        <button id="btnClear">Vider le cache</button>
        <button id="btnReload">Recharger</button>
      </div>
    </div>
  </div>

  <header>
    <div>
      <h1>Yam’s — Scores & Classement</h1>
      <div class="sub">Classement unifié, bouton de manche unique, stats & graphiques clarifiés.</div>
    </div>
    <div class="spacer"></div>
    <button id="settingsBtn" class="settings-btn" title="Réglages">⚙︎</button>
  </header>

  <main>
    <div class="toolbar">
      <input id="playerName" placeholder="Nom du joueur" />
      <button id="addPlayerBtn">Ajouter</button>
      <button id="roundToggleBtn">Nouvelle manche</button>
      <button id="openHistoryBtn">Historique</button>
    </div>

    <section class="leaderboard" id="leaderboard">
      <div class="lb-title" id="lbTitle"><strong>Classement (tap pour mettre en avant une vue)</strong> <span class="hint">Manche actuelle • Moyenne (global) • Victoires</span></div>
      <div class="lb-grid">
        <div class="lb-block highlight" id="lb-current"><h4>Manche actuelle</h4><div id="lbCurrentPills"></div></div>
        <div class="lb-block" id="lb-avg"><h4>Moyenne — toutes les manches</h4><div id="lbAvgPills"></div></div>
        <div class="lb-block" id="lb-wins"><h4>Par victoires</h4><div id="lbWinsPills"></div></div>
      </div>
    </section>

    <div class="table-wrap">
      <table id="scoreTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <div id="printView">
    <h2>Export</h2>
    <h3>Classements</h3>
    <div id="printLeaderboards"></div>
    <h3>Scores par partie</h3>
    <div id="printRoundsTable"></div>
    <h3>Stats par joueur</h3>
    <div id="printPlayersStats"></div>
  </div>

  <!-- Settings Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="close-line"><button id="closeSettings" class="ghost-btn" aria-label="Fermer">✕</button></div>
    <h3 id="settingsTitle">Réglages</h3>

    <div class="section">
      <h4>Thème</h4>
      <div class="radio-row">
        <label><input type="radio" name="themeMode" value="auto"> Auto (appareil)</label>
        <label><input type="radio" name="themeMode" value="light"> Clair</label>
        <label><input type="radio" name="themeMode" value="dark"> Sombre</label>
      </div>
    </div>

    <div class="section">
      <h4>Affichage</h4>
      <div class="row">
        <label>Zoom :</label>
        <button class="ghost-btn" data-zoom="0.9">Petit</button>
        <button class="ghost-btn" data-zoom="1">Normal</button>
        <button class="ghost-btn" data-zoom="1.1">Grand</button>
      </div>
      <div class="row">
        <label>Densité :</label>
        <button class="ghost-btn" data-dense="0">Normal</button>
        <button class="ghost-btn" data-dense="1">Compact</button>
        <button class="ghost-btn" data-dense="2">Ultra</button>
      </div>
      <div class="row">
        <label for="colWidth">Largeur des colonnes :</label>
        <select id="colWidth">
          <option value="130">Petit</option>
          <option value="150" selected>Standard</option>
          <option value="180">Grand</option>
        </select>
      </div>
    </div>

    <div class="section">
      <h4>Données</h4>
      <div class="actions">
        <button id="exportBtn">Exporter (JSON)</button>
        <button id="importBtn">Importer (JSON)</button>
        <button id="exportPdfBtn">Exporter en PDF</button>
        <button id="clearCacheBtn" class="danger-btn" title="Supprimer les caches et le service worker">Vider le cache</button>
        <input id="importFile" class="hidden-input" type="file" accept="application/json" />
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="close-line"><button id="closeHistory" class="ghost-btn" aria-label="Fermer">✕</button></div>
    <h3 id="historyTitle">Historique des manches</h3>
    <div id="historyList" class="history-list"></div>
    <div class="actions" style="margin-top:8px;">
      <button id="clearHistoryBtn" class="danger-btn">Effacer l’historique</button>
    </div>
  </div>

  <!-- Player Stats Modal -->
  <div id="playerStatsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="playerStatsTitle">
    <div class="close-line"><button id="closePlayerStats" class="ghost-btn" aria-label="Fermer">✕</button></div>
    <h3 id="playerStatsTitle">Stats joueur</h3>
    <div id="playerStatsContent"></div>
  </div>

<script>
// Error overlay bootstrap
(function(){
  const overlay = document.getElementById('errOverlay');
  const txt = document.getElementById('errText');
  const btnCopy = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const btnReload = document.getElementById('btnReload');
  function showErr(message, source, lineno, colno, error){
    overlay.style.display = 'block';
    txt.textContent = [message, source?(`@ ${source}:${lineno}:${colno}`):"", error && error.stack ? ("\n"+error.stack) : ""].join(" ");
  }
  window.addEventListener('error', (e)=>{
    showErr(e.message, e.filename, e.lineno, e.colno, e.error);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    showErr('Unhandled Promise rejection', '', 0, 0, e.reason);
  });
  btnCopy.addEventListener('click', ()=>{
    navigator.clipboard.writeText(txt.textContent||"");
  });
  btnClear.addEventListener('click', async ()=>{
    try{
      const keys = await caches.keys(); await Promise.all(keys.map(k => caches.delete(k)));
      if (navigator.serviceWorker){ const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r => r.unregister())); }
    }catch(e){}
    location.reload();
  });
  btnReload.addEventListener('click', ()=> location.reload());
})();
</script>

<script>
(function(){
  const CATS_UPPER = [
    {key:'ones',   label:'1 ×', hint:'Somme des 1', max:5},
    {key:'twos',   label:'2 ×', hint:'Somme des 2', max:10},
    {key:'threes', label:'3 ×', hint:'Somme des 3', max:15},
    {key:'fours',  label:'4 ×', hint:'Somme des 4', max:20},
    {key:'fives',  label:'5 ×', hint:'Somme des 5', max:25},
    {key:'sixes',  label:'6 ×', hint:'Somme des 6', max:30},
  ];
  const CATS_LOWER = [
    {key:'threeKind', label:'Brelan',        hint:'Somme des dés', max:30},
    {key:'fourKind',  label:'Carré',         hint:'Somme des dés', max:30},
    {key:'fullHouse', label:'Full',          hint:'25 pts',        max:25},
    {key:'smallStr',  label:'Petite suite',  hint:'30 pts',        max:30},
    {key:'largeStr',  label:'Grande suite',  hint:'40 pts',        max:40},
    {key:'yahtzee',   label:'Yam’s',         hint:'50 pts',        max:50},
    {key:'chance',    label:'Chance',        hint:'Somme des dés', max:30},
  ];
  const ALL_CATS = [...CATS_UPPER, ...CATS_LOWER];

  const STORAGE_KEY = "yams-app-pages-v6.1-table";
  const ROUNDS_KEY = "yams-rounds-v7";
  const ROUNDS_STATE_KEY = "yams-round-active";
  const THEME_KEY = "yams-theme-mode";
  const UI_KEY = "yams-ui-v7";

  const mql = window.matchMedia("(prefers-color-scheme: dark)");
  function applyTheme(mode){
    let theme = mode; if (mode === "auto"){ theme = mql.matches ? "dark" : "light"; }
    document.documentElement.setAttribute("data-theme", theme);
    document.querySelectorAll('input[name="themeMode"]').forEach(r=> r.checked = (r.value === mode));
  }
  function initTheme(){
    const mode = localStorage.getItem(THEME_KEY) || "auto";
    applyTheme(mode);
    mql.addEventListener && mql.addEventListener("change", ()=>{
      if ((localStorage.getItem(THEME_KEY) || "auto") === "auto"){ applyTheme("auto"); }
    });
  }
  initTheme();

  function applyUI(ui){
    if (!ui) return;
    if (ui.scale){ document.documentElement.setAttribute("data-scale", String(ui.scale)); }
    document.documentElement.setAttribute("data-dense", String(ui.dense ?? 0));
    if (ui.colMin){ document.documentElement.style.setProperty("--col-min", ui.colMin + "px"); }
    const cw = document.getElementById("colWidth"); if (cw) cw.value = String(ui.colMin || 150);
  }
  function loadUI(){ try{ return Object.assign({ scale:1, dense:0, colMin:150}, JSON.parse(localStorage.getItem(UI_KEY) || "{}")); } catch(e){ return {scale:1, dense:0, colMin:150}; } }
  function saveUI(ui){ try{ localStorage.setItem(UI_KEY, JSON.stringify(ui)); } catch(e){} }
  let uiState = loadUI(); applyUI(uiState);

  let state = loadState() || { players: [] };
  function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }
  function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
  let rounds = loadRounds();
  function loadRounds(){ try{ return JSON.parse(localStorage.getItem(ROUNDS_KEY) || "[]"); } catch(e){ return []; } }
  function saveRounds(){ try{ localStorage.setItem(ROUNDS_KEY, JSON.stringify(rounds)); } catch(e){} }
  let roundActive = localStorage.getItem(ROUNDS_STATE_KEY) === "1";

  function canonicalName(name){ return (name || "").trim().toLowerCase(); }
  function nameExists(name, exceptId=null){ const cn = canonicalName(name); return state.players.some(p => canonicalName(p.name) === cn && p.id !== exceptId); }
  function newPlayer(name){ const scores = {}; ALL_CATS.forEach(c => scores[c.key] = ""); return { id: crypto.randomUUID(), name, scores }; }
  function num(v){ const n = Number(v); return isFinite(n) ? n : 0; }
  function sumUpper(scores){ return CATS_UPPER.reduce((s,c)=> s + num(scores[c.key]||0), 0); }
  function sumLower(scores){ return CATS_LOWER.reduce((s,c)=> s + num(scores[c.key]||0), 0); }
  function bonus(upper){ return upper >= 63 ? 35 : 0; }
  function totals(scores){ const u = sumUpper(scores), b = bonus(u), l = sumLower(scores); return { upper:u, bonus:b, lower:l, total:u + b + l }; }
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[s])); }
  function countFilled(scores){ return Object.values(scores).filter(v => v !== "" && v != null).length; }
  function categoryProgress(scores){ let sum=0, maxSum=0; CATS_UPPER.forEach(c=>{ sum += num(scores[c.key]); maxSum += c.max; }); CATS_LOWER.forEach(c=>{ sum += num(scores[c.key]); maxSum += c.max; }); return maxSum ? sum/maxSum : 0; }

  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");

  function buildTable(){
    thead.innerHTML = "";
    const trHead = document.createElement("tr");
    const thCat = document.createElement("th"); thCat.className = "cat"; thCat.textContent = "Catégorie"; trHead.appendChild(thCat);

    state.players.forEach(p => {
      const th = document.createElement("th");
      th.className = "player"; th.dataset.playerId = p.id;
      th.innerHTML = `<div class="player-head">
        <span class="name">${escapeHtml(p.name || "Sans nom")}</span>
        <button data-action="stats" title="Stats">📈</button>
        <button data-action="rename" title="Renommer">✎</button>
        <button data-action="delete" class="danger" title="Supprimer">✕</button>
      </div>`;
      th.querySelector('[data-action="stats"]').addEventListener('click', ()=> openPlayerStats(p.id));
      th.querySelector('[data-action="rename"]').addEventListener('click', ()=>{
        const current = p.name || "";
        const newName = prompt("Nouveau nom du joueur :", current);
        if (newName !== null){
          const trimmed = newName.trim();
          if (!trimmed){ alert("Le nom ne peut pas être vide."); return; }
          if (nameExists(trimmed, p.id)){ alert("Ce prénom existe déjà. Choisissez un autre nom."); return; }
          p.name = trimmed; th.querySelector(".name").textContent = p.name; saveState(); renderLeaderboards();
        }
      });
      th.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
        if (confirm(`Supprimer ${p.name || "ce joueur"} ?`)){
          state.players = state.players.filter(pl => pl.id !== p.id); saveState(); buildTable(); renderLeaderboards();
        }
      });
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    tbody.innerHTML = "";
    function addRow(label, key, hint, max, className="", isLast=false){
      const tr = document.createElement("tr"); if (isLast) tr.classList.add("last-row");
      const tdCat = document.createElement("td"); tdCat.className = "cat " + className; tdCat.innerHTML = `${label} ${hint?`<span class="muted">(${hint})</span>`:""}`; tr.appendChild(tdCat);
      state.players.forEach(p => {
        const td = document.createElement("td"); td.className = "cell " + className;
        if (key[0] !== "_"){
          const input = document.createElement("input");
          input.type = "number"; input.inputMode = "numeric"; input.pattern = "[0-9]*";
          if (max != null){ input.placeholder = `0…${max}`; input.title = `Score max: ${max}`; }
          input.min = "0"; input.step = "1"; input.value = p.scores[key];
          applyFillClass(input);
          input.addEventListener("keydown", (e)=>{ if (e.key === "ArrowUp" || e.key === "ArrowDown"){ e.preventDefault(); } });
          input.addEventListener("input", ()=>{
            const raw = input.value.replace(/[^\d]/g, ""); const v = raw === "" ? "" : clampInt(raw, 0, max ?? 200);
            if (String(v) != input.value){ input.value = v; }
            p.scores[key] = raw === "" ? "" : v; applyFillClass(input); saveState(); refreshComputedForPlayer(p.id); renderLeaderboards();
          });
          td.appendChild(input);
        } else { td.textContent=""; }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    CATS_UPPER.forEach(cat => addRow(cat.label, cat.key, cat.hint, cat.max));
    addRow("Sous-total (1→6)", "_upper", "", null, "subtotal");
    addRow("Bonus (≥63)", "_bonus", "", null, "subtotal");
    CATS_LOWER.forEach(cat => addRow(cat.label, cat.key, cat.hint, cat.max));
    addRow("Total", "_total", "", null, "total", true);

    state.players.forEach(p => refreshComputedForPlayer(p.id));
  }
  function applyFillClass(input){ if (String(input.value).trim() === ""){ input.classList.add("is-empty"); input.classList.remove("is-filled"); } else { input.classList.remove("is-empty"); input.classList.add("is-filled"); } }
  function clampInt(v, min, max){ let n = parseInt(v, 10); if (!isFinite(n)) n = 0; if (n < min) n = min; if (n > max) n = max; return n; }
  function totalsForPlayer(p){ return totals(p.scores).total; }
  function refreshComputedForPlayer(playerId){
    const p = state.players.find(x => x.id === playerId); if (!p) return;
    const t = totals(p.scores);
    const colIdx = state.players.findIndex(x => x.id === playerId);
    const rows = tbody.querySelectorAll("tr");
    const upperCount = CATS_UPPER.length;
    const subtotalRow = rows[upperCount];
    const bonusRow = rows[upperCount + 1];
    const totalRow = rows[upperCount + 1 + CATS_LOWER.length + 1];
    function setCellText(tr, idx, text, cls){ const td = tr.children[idx + 1]; if (!td) return; td.textContent = String(text); td.className = "cell " + (cls || ""); }
    setCellText(subtotalRow, colIdx, t.upper, "subtotal");
    setCellText(bonusRow, colIdx, t.bonus, "subtotal");
    setCellText(totalRow, colIdx, t.total, "total");
  }

  // Leaderboards unified (3 blocks)
  const lbTitle = document.getElementById("lbTitle");
  const lbCurrentPills = document.getElementById("lbCurrentPills");
  const lbAvgPills = document.getElementById("lbAvgPills");
  const lbWinsPills = document.getElementById("lbWinsPills");
  const lbBlocks = ["lb-current","lb-avg","lb-wins"];
  let hlIndex = 0;
  lbTitle.addEventListener("click", ()=>{
    document.getElementById(lbBlocks[hlIndex]).classList.remove("highlight");
    hlIndex = (hlIndex + 1) % lbBlocks.length;
    document.getElementById(lbBlocks[hlIndex]).classList.add("highlight");
  });

  function winsTable(){
    const wins = {}; state.players.forEach(p => wins[p.id]=0);
    rounds.forEach(r => {
      let best = -Infinity, bestId=null;
      Object.entries(r.totals).forEach(([id,t])=>{ const v=Number(t)||0; if (v>best){ best=v; bestId=id; } });
      if (bestId && wins[bestId]!=null) wins[bestId]++;
    });
    return wins;
  }

  function renderLeaderboards(){
    // current
    lbCurrentPills.innerHTML = "";
    const cur = state.players.map(p => ({ id:p.id, name:p.name||"Sans nom", total: totals(p.scores).total })).sort((a,b)=> b.total - a.total);
    cur.forEach((r,i)=>{ const s=document.createElement("span"); s.className="rank-pill"; s.textContent=`${i+1}. ${r.name} — ${r.total}`; lbCurrentPills.appendChild(s); });
    // avg
    lbAvgPills.innerHTML = "";
    const avg = state.players.map(p => { const st = getStatsAllRoundsForPlayer(p.id); return { id:p.id, name:p.name||"Sans nom", avg: st.avg || 0, best: st.best || 0 }; }).sort((a,b)=> b.avg - a.avg);
    avg.forEach((r,i)=>{ const s=document.createElement("span"); s.className="rank-pill"; s.textContent=`${i+1}. ${r.name} — moy ${r.avg} (max ${r.best})`; lbAvgPills.appendChild(s); });
    // wins
    lbWinsPills.innerHTML = "";
    const wmap = winsTable();
    const wr = state.players.map(p => ({ id:p.id, name:p.name||"Sans nom", w: wmap[p.id]||0 })).sort((a,b)=> b.w - a.w);
    wr.forEach((r,i)=>{ const s=document.createElement("span"); s.className="rank-pill"; s.textContent=`${i+1}. ${r.name} — ${r.w} vic.`; lbWinsPills.appendChild(s); });
  }

  // Round toggle button (single)
  const roundToggleBtn = document.getElementById("roundToggleBtn");
  function updateRoundBtn(){ roundToggleBtn.textContent = roundActive ? "Clôturer la manche" : "Nouvelle manche"; }
  updateRoundBtn();
  roundToggleBtn.addEventListener('click', ()=>{
    if (!roundActive){
      if (!confirm("Commencer une nouvelle manche ? (réinitialise les cases)")) return;
      state.players.forEach(p => { Object.keys(p.scores).forEach(k => p.scores[k] = ""); });
      saveState(); buildTable(); renderLeaderboards();
      roundActive = true; localStorage.setItem(ROUNDS_STATE_KEY, "1"); updateRoundBtn();
    } else {
      if (!state.players.length){ alert("Aucun joueur."); return; }
      const totalsMap = {}; state.players.forEach(p => totalsMap[p.id] = totalsForPlayer(p));
      rounds.push({ time: new Date().toISOString(), totals: totalsMap });
      saveRounds(); alert("Manche enregistrée !");
      roundActive = false; localStorage.setItem(ROUNDS_STATE_KEY, "0"); updateRoundBtn(); renderLeaderboards();
    }
  });

  // History
  const historyModal = document.getElementById("historyModal");
  const historyList = document.getElementById("historyList");
  document.getElementById("openHistoryBtn").addEventListener('click', ()=>{ renderHistory(); backdrop.classList.add("open"); historyModal.classList.add("open"); });
  document.getElementById("closeHistory").addEventListener('click', ()=>{ backdrop.classList.remove("open"); historyModal.classList.remove("open"); });
  document.getElementById("clearHistoryBtn").addEventListener('click', ()=>{
    if (!rounds.length) return; if (!confirm("Effacer tout l’historique des manches ?")) return;
    rounds = []; saveRounds(); renderHistory(); renderLeaderboards();
  });
  function renderHistory(){
    historyList.innerHTML = "";
    if (!rounds.length){ historyList.innerHTML = "<div class='muted' style='padding:8px'>Aucune manche enregistrée.</div>"; return; }
    rounds.slice().reverse().forEach((r)=>{
      const div = document.createElement("div"); div.className = "history-item";
      const date = new Date(r.time).toLocaleString();
      const arr = Object.entries(r.totals).map(([id, t])=>{
        const name = (state.players.find(p=>p.id===id)?.name) || "Joueur";
        return {id, name, t: Number(t)||0};
      }).sort((a,b)=>b.t-a.t).slice(0,3);
      const summary = arr.map((x,i)=> `${i+1}. ${x.name} ${x.t}`).join(" • ");
      div.innerHTML = `<div><strong>Manche</strong> — ${date}<br><span class="muted">${summary}</span></div>`;
      historyList.appendChild(div);
    });
  }

  // Stats (global)
  function getStatsAllRoundsForPlayer(id){
    const scores = rounds.map(r => r.totals[id]).filter(v => typeof v === "number");
    const count = scores.length;
    if (!count) return {avg:null, best:null, worst:null, count:0, scores:[], wins:0, podiums:0, winRate:0, recentAvg:null, trend:null, bestStreak:0};
    const sum = scores.reduce((a,b)=>a+b,0);
    const avg = Math.round(sum / count);
    const best = Math.max(...scores);
    const worst = Math.min(...scores);
    let wins=0, podiums=0;
    rounds.forEach(r=>{
      const arr = Object.entries(r.totals).map(([pid,t])=>({pid, t:Number(t)||0})).sort((a,b)=>b.t-a.t);
      const rank = arr.findIndex(x=>x.pid===id);
      if (rank===0) wins++;
      if (rank>-1 && rank<3) podiums++;
    });
    const winRate = Math.round( (wins / count) * 100 );
    const last5 = scores.slice(-5);
    const recentAvg = Math.round(last5.reduce((a,b)=>a+b,0)/last5.length);
    const trend = recentAvg - avg;
    let bestStreak=0, cur=0;
    rounds.forEach(r=>{
      const arr = Object.entries(r.totals).map(([pid,t])=>({pid, t:Number(t)||0})).sort((a,b)=>b.t-a.t);
      if (arr[0] && arr[0].pid===id){ cur++; bestStreak=Math.max(bestStreak,cur); } else { cur=0; }
    });
    return {avg, best, worst, count, scores, wins, podiums, winRate, recentAvg, trend, bestStreak};
  }
  function percentileCurrent(total){
    const totalsArr = state.players.map(p=> totals(p.scores).total );
    const sorted = totalsArr.slice().sort((a,b)=>a-b);
    const idx = sorted.findIndex(x=>x>=total);
    const pos = (idx===-1)?sorted.length-1:idx;
    return Math.round( (pos+1)/Math.max(1,sorted.length) * 100 );
  }

  const playerStatsModal = document.getElementById("playerStatsModal");
  const playerStatsContent = document.getElementById("playerStatsContent");
  document.getElementById("closePlayerStats").addEventListener('click', ()=>{ backdrop.classList.remove("open"); playerStatsModal.classList.remove("open"); });

  function openPlayerStats(playerId){
    const p = state.players.find(x=>x.id===playerId); if (!p) return;
    const name = escapeHtml(p.name||"Joueur");
    const cur = totals(p.scores);
    const currentSorted = state.players.map(x=>({id:x.id, total: totals(x.scores).total})).sort((a,b)=>b.total-a.total);
    const rank = currentSorted.findIndex(x=>x.id===playerId)+1 || "-";
    const leader = currentSorted[0]; const me = currentSorted.find(x=>x.id===playerId) || {total:0};
    const diffLeader = leader ? (leader.total - me.total) : 0;
    const filled = countFilled(p.scores); const totalCells = Object.keys(p.scores).length;
    const prog = Math.round(categoryProgress(p.scores)*100);
    const up = sumUpper(p.scores), lo = sumLower(p.scores), bon = bonus(up), need = Math.max(0, 63 - up);
    const perc = percentileCurrent(me.total);

    const all = getStatsAllRoundsForPlayer(playerId);
    const svg = makeChart(all.scores, "Manche n°", "Score total");

    playerStatsContent.innerHTML = `
      <div class="stats-grid mini">
        <div class="card">
          <h4>Manche actuelle — ${name}</h4>
          <div class="kv">
            <b>Total</b><span>${cur.total} (Haut ${up}+${bon}, Bas ${lo})</span>
            <b>Rang</b><span>${rank} / ${state.players.length} — Écart leader: ${diffLeader>0?`-${diffLeader}`:"—"}</span>
            <b>Progression</b><span>${prog}% — Cases ${filled}/${totalCells} — Bonus 63: ${bon?`✅`:`❌ (${need} pts)`}</span>
            <b>Percentile</b><span>~${perc}ᵉ</span>
          </div>
        </div>
        <div class="card">
          <h4>Toutes les manches — ${name}</h4>
          <div class="kv">
            <b>Parties</b><span>${all.count}</span>
            <b>Victoires</b><span>${all.wins} (${all.winRate}%)</span>
            <b>Podiums</b><span>${all.podiums}</span>
            <b>Moyenne</b><span>${all.avg ?? "-"}</span>
            <b>Meilleur / Pire</b><span>${all.best ?? "-"} / ${all.worst ?? "-"}</span>
            <b>5 dernières</b><span>${all.recentAvg ?? "-"}</span>
            <b>Tendance</b><span>${all.trend>0?`+${all.trend}`:all.trend}</span>
            <b>Série (wins)</b><span>${all.bestStreak}</span>
          </div>
          <div class="chart">${svg}</div>
        </div>
      </div>
    `;
    backdrop.classList.add("open"); playerStatsModal.classList.add("open");
  }

  function makeChart(values, xlabel, ylabel){
    if (!values || !values.length) return "<em class='muted'>Pas encore de parties</em>";
    const w=360,h=160,p=28;
    const max = Math.max(...values, 1); const min = Math.min(...values, 0);
    const range = Math.max(1, max-min);
    const step = (w-2*p)/Math.max(1, values.length-1);
    const pts = values.map((v,i)=>{
      const x = p + i*step;
      const y = h - p - ((v-min)/range)*(h-2*p);
      return `${x},${y}`;
    }).join(" ");
    const y0 = h-p, x0 = p;
    const yTicks = 4;
    let ticks = "";
    for(let i=0;i<=yTicks;i++){
      const val = min + (range * i / yTicks);
      const y = h - p - ((val-min)/range)*(h-2*p);
      ticks += `<text x="${x0-6}" y="${y+4}" font-size="10" text-anchor="end">${Math.round(val)}</text>`;
      ticks += `<line x1="${x0}" y1="${y}" x2="${w-p}" y2="${y}" stroke="currentColor" opacity="0.15"/>`;
    }
    const xLabels = `<text x="${x0}" y="${h-6}" font-size="10" text-anchor="middle">1</text>
                     <text x="${(w)/2}" y="${h-6}" font-size="10" text-anchor="middle">${Math.ceil(values.length/2)}</text>
                     <text x="${w-p}" y="${h-6}" font-size="10" text-anchor="middle">${values.length}</text>`;
    return `<svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
      <line x1="${x0}" y1="${y0}" x2="${w-p}" y2="${y0}" stroke="currentColor" />
      <line x1="${x0}" y1="${p/2}" x2="${x0}" y2="${y0}" stroke="currentColor" />
      ${ticks}
      ${xLabels}
      <polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts}"></polyline>
      <text x="${w/2}" y="${p/2 - 6}" font-size="11" text-anchor="middle">${ylabel}</text>
      <text x="${w/2}" y="${h-2}" font-size="11" text-anchor="middle">${xlabel}</text>
    </svg>`;
  }

  // Export JSON with computed_stats (fixed)
  function buildComputedStats(){
    const wins = winsTable();
    const playersStats = {};
    state.players.forEach(p=>{
      const curTot = totals(p.scores);
      const all = getStatsAllRoundsForPlayer(p.id);
      playersStats[p.id] = {
        name: p.name || "Joueur",
        current_round: {
          total: curTot.total, upper: curTot.upper, bonus: curTot.bonus, lower: curTot.lower,
          filled_cells: countFilled(p.scores),
          progress_pct: Math.round(categoryProgress(p.scores)*100)
        },
        all_rounds: {
          count: all.count, wins: all.wins, win_rate: all.winRate, podiums: all.podiums,
          avg: all.avg, best: all.best, worst: all.worst,
          recent_avg_5: all.recentAvg, trend_vs_avg: all.trend, best_win_streak: all.bestStreak,
          scores: all.scores
        }
      };
    });
    return { players: playersStats, rounds_count: rounds.length };
  }

  // Export / Import / PDF
  document.getElementById("exportBtn").addEventListener('click', ()=>{
    const payload = { state, rounds, computed_stats: buildComputedStats() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "yams-data.json";
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
  });
  const importFile = document.getElementById("importFile");
  document.getElementById("importBtn").addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', ()=>{
    const file = importFile.files && importFile.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(String(reader.result));
        if (!data || !data.state || !Array.isArray(data.state.players)) throw new Error("Format invalide");
        state = data.state; saveState();
        rounds = Array.isArray(data.rounds) ? data.rounds : []; saveRounds();
        buildTable(); renderLeaderboards(); updateRoundBtn();
      }catch(err){ alert("Fichier invalide : " + err.message); }
    };
    reader.readAsText(file);
  });

  document.getElementById("exportPdfBtn").addEventListener('click', ()=>{
    buildPrintView();
    window.print();
  });

  function buildPrintView(){
    const wrapLB = document.getElementById("printLeaderboards");
    const wrapRounds = document.getElementById("printRoundsTable");
    const wrapStats = document.getElementById("printPlayersStats");
    wrapLB.innerHTML = ""; wrapRounds.innerHTML = ""; wrapStats.innerHTML = "";

    const lbCurrent = state.players.map(p => ({ id:p.id, name:p.name||"Sans nom", total: totals(p.scores).total })).sort((a,b)=> b.total - a.total);
    const lbAvg = state.players.map(p => { const st = getStatsAllRoundsForPlayer(p.id); return { name:p.name||"Sans nom", avg: st.avg || 0, best: st.best || 0 }; }).sort((a,b)=> b.avg - a.avg);
    const wmap = winsTable(); const lbWins = state.players.map(p => ({ name:p.name||"Sans nom", w: wmap[p.id]||0 })).sort((a,b)=> b.w - a.w);

    wrapLB.innerHTML = `
      <div><strong>Manche actuelle :</strong> ${lbCurrent.map((r,i)=>`${i+1}. ${r.name} — ${r.total}`).join(" • ") || "<em>Aucun joueur</em>"}</div>
      <div><strong>Moyenne (global) :</strong> ${lbAvg.map((r,i)=>`${i+1}. ${r.name} — moy ${r.avg} (max ${r.best})`).join(" • ") || "<em>Aucun joueur</em>"}</div>
      <div><strong>Par victoires :</strong> ${lbWins.map((r,i)=>`${i+1}. ${r.name} — ${r.w} vic.`).join(" • ") || "<em>Aucun joueur</em>"}</div>
    `;

    const players = state.players;
    const head = `<tr><th>Partie</th>${players.map(p=>`<th>${escapeHtml(p.name||"Joueur")}</th>`).join("")}</tr>`;
    const rows = rounds.map((r,i)=>{
      const date = new Date(r.time).toLocaleString();
      const tds = players.map(p => `<td style="text-align:right">${r.totals[p.id]??""}</td>`).join("");
      return `<tr><td>${i+1} — ${date}</td>${tds}</tr>`;
    }).join("");
    wrapRounds.innerHTML = `<table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse;width:100%">${head}${rows||"<tr><td colspan='"+(players.length+1)+"'><em>Aucune partie</em></td></tr>"}</table>`;

    let statsHtml = "";
    state.players.forEach(p=>{
      const all = getStatsAllRoundsForPlayer(p.id);
      const svg = makeChart(all.scores, "Manche n°", "Score total");
      const cur = totals(p.scores);
      statsHtml += `<div style="margin:8px 0;padding:8px;border:1px solid #999">
        <strong>${escapeHtml(p.name||"Joueur")}</strong>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <u>Manche actuelle</u><br>
            Total ${cur.total} (Haut ${cur.upper}+${cur.bonus}, Bas ${cur.lower})<br>
            Cases ${countFilled(p.scores)} — Prog. ~${Math.round(categoryProgress(p.scores)*100)}% — Bonus ${cur.bonus? "OK" : "Non"}
          </div>
          <div>
            <u>Toutes les manches</u><br>
            Moy ${all.avg??"-"} • Max ${all.best??"-"} • Min ${all.worst??"-"}<br>
            Parties ${all.count} • Wins ${all.wins} (${all.winRate}%) • Podiums ${all.podiums}<br>
            5 der. ${all.recentAvg??"-"} • Tendance ${all.trend>0?`+${all.trend}`:all.trend} • Streak ${all.bestStreak}
          </div>
        </div>
        <div>${svg}</div>
      </div>`;
    });
    wrapStats.innerHTML = statsHtml;
  }

  // UI: add/remove players, import/export, cache, settings
  document.getElementById("addPlayerBtn").addEventListener('click', ()=>{
    const nameInput = document.getElementById("playerName");
    const name = (nameInput.value || "").trim();
    if (!name){ alert("Entrez un nom de joueur."); nameInput.focus(); return; }
    if (nameExists(name)){ alert("Ce prénom existe déjà. Choisissez un autre nom."); return; }
    const p = newPlayer(name);
    state.players.push(p);
    saveState(); buildTable(); renderLeaderboards();
    nameInput.value = "";
  });
  document.getElementById("playerName").addEventListener('keydown', (e)=>{ if (e.key === "Enter") document.getElementById("addPlayerBtn").click(); });

  const settingsBtn = document.getElementById("settingsBtn");
  const backdrop = document.getElementById("backdrop");
  const modal = document.getElementById("settingsModal");
  const closeSettings = document.getElementById("closeSettings");
  function openSettings(){ backdrop.classList.add("open"); modal.classList.add("open"); }
  function closeSettingsModal(){ backdrop.classList.remove("open"); modal.classList.remove("open"); }
  settingsBtn.addEventListener("click", openSettings);
  closeSettings.addEventListener("click", closeSettingsModal);
  backdrop.addEventListener("click", ()=>{ closeSettingsModal(); document.getElementById("historyModal").classList.remove("open"); document.getElementById("playerStatsModal").classList.remove("open"); });

  document.getElementById("exportPdfBtn").addEventListener('click', ()=>{ buildPrintView(); window.print(); });
  document.getElementById("clearCacheBtn").addEventListener('click', async ()=>{
    if (!confirm("Vider le cache et redémarrer l’application ?")) return;
    try{
      const keys = await caches.keys(); await Promise.all(keys.map(k => caches.delete(k)));
      if (navigator.serviceWorker){ const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r => r.unregister())); }
    }catch(e){ console.warn(e); }
    location.reload();
  });

  // Initial
  buildTable(); renderLeaderboards(); updateRoundBtn();

  // SW
  if ("serviceWorker" in navigator){ window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw-v11.1.js")); }
})();
</script>
</body>
</html>
