<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="manifest.webmanifest?v=3">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Yam’s — Scores & Classement</title>
<style>
  :root{
    --gap:14px; --radius:16px;
    --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#475569;
    --border: rgba(15,23,42,.15); --row-alt: rgba(2,6,23,.05);
    --accent-soft: rgba(59,130,246,.12); --accent-border: rgba(59,130,246,.35);
    --danger: rgba(239,68,68,.35); --danger-text:#7f1d1d;
    --notice: rgba(59,130,246,.45); --notice-text:#1e3a8a;
  }
  html[data-theme="dark"]{
    --bg:#0f172a; --panel:#0b1220; --text:#e2e8f0; --muted:#94a3b8;
    --border: rgba(148,163,184,.25); --row-alt: rgba(2,6,23,.35);
    --accent-soft: rgba(59,130,246,.15); --accent-border: rgba(59,130,246,.35);
    --danger: rgba(239,68,68,.5); --danger-text:#fecaca;
    --notice: rgba(59,130,246,.5); --notice-text:#bfdbfe;
  }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Segoe UI, Roboto, Helvetica, Arial; }
  header { position: sticky; top: 0; z-index: 20; backdrop-filter: saturate(180%) blur(6px);
    padding: max(12px, env(safe-area-inset-top)) 16px 12px 16px; background: color-mix(in oklab, var(--panel) 85%, transparent); border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
  }
  h1{ font-size: clamp(20px, 2.6vw, 28px); margin:0; line-height:1.2; }
  .sub{ color:var(--muted); font-size: 1rem; }
  .spacer{ flex:1; }
  main{ padding: 16px; display:grid; gap:16px; }
  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button, input{
    background:#fff; color:var(--text); border:1px solid var(--border); padding:12px 14px; border-radius:12px; outline:none;
    min-height:44px; font-size:18px;
  }
  html[data-theme="dark"] button, html[data-theme="dark"] input { background:#111827; }
  input[type="number"]{ width: 110px; text-align: right; -moz-appearance: textfield; }
  input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .players { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:16px; }
  .card { background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
  .card header { display:flex; align-items:center; justify-content:space-between; border:none; padding:0 0 8px 0; }
  .name { font-weight:700; font-size:1.15rem; }
  table { width:100%; border-collapse: collapse; margin-top:8px; }
  th, td { border-bottom: 1px dashed var(--border); padding: 10px 6px; font-size:18px; }
  th { text-align:left; color: var(--text); font-weight:700; }
  td:last-child, th:last-child { text-align:right; }
  .muted { color: var(--muted); font-size:16px; }
  .total { font-weight:800; font-size:20px; }
  .leaderboard { background: var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px; }
  .leaderboard h2 { margin:0 0 6px 0; font-size:1.1rem; }
  .rank-row{ display:grid; grid-template-columns:40px 1fr 110px; gap:12px; align-items:center; padding:10px; border-radius:12px; }
  .rank-row:nth-child(odd){ background: var(--row-alt); }
  .rank-badge{ width:34px; height:34px; display:grid; place-items:center; background: var(--accent-soft); border: 1px solid var(--accent-border); border-radius:50%; font-weight:800; }
  .row-actions{ display:flex; gap:8px; }
  .pill{ font-size:16px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); }
  .danger{ border-color: var(--danger); color: var(--danger-text); }
  .notice{ border-color: var(--notice); color: var(--notice-text); }
  .footer { color: var(--muted); font-size:16px; text-align:center; padding:12px; padding-bottom: max(12px, env(safe-area-inset-bottom)); }

  /* Settings button (top-right) */
  .settings-btn{
    margin-left:auto;
    width:44px; height:44px; display:grid; place-items:center; border-radius:12px;
  }

  /* Modal settings */
  .backdrop{
    position: fixed; inset: 0; background: rgba(0,0,0,.35);
    display:none; z-index: 90;
  }
  .backdrop.open{ display:block; }
  .modal{
    position: fixed; z-index: 100;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: min(520px, calc(100vw - 32px));
    background: var(--panel); color: var(--text);
    border: 1px solid var(--border); border-radius: 16px; padding: 16px;
    box-shadow: 0 24px 64px rgba(0,0,0,.25);
    display:none;
  }
  .modal.open{ display:block; }
  .modal h3{ margin: 0 0 12px 0; font-size: 1.1rem; }
  .radio-row{ display:flex; align-items:center; gap:10px; padding:8px 0; }
  .modal .actions{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
  .modal .close-line{ display:flex; justify-content:flex-end; }
  .ghost-btn{ background: transparent; }
  .hidden-input{ display:none; }
</style>
</head>
<body>
  <header>
    <div>
      <h1>Yam’s — Scores & Classement</h1>
      <div class="sub">Saisie fluide, limites par catégorie, PWA iPad-friendly.</div>
    </div>
    <div class="spacer"></div>
    <button id="settingsBtn" class="settings-btn" title="Réglages">⚙︎</button>
  </header>

  <main>
    <div class="toolbar">
      <input id="playerName" placeholder="Nom du joueur" />
      <button id="addPlayerBtn">Ajouter</button>
      <button id="resetAllBtn">Tout réinitialiser</button>
    </div>

    <section class="leaderboard" id="leaderboard">
      <h2>Classement</h2>
      <div id="rankingRows"></div>
      <div class="muted" id="leaderboardHint"></div>
    </section>
    <section class="players" id="players"></section>
  </main>

  <div class="footer">Bonus +35 si (1→6) ≥ 63. Limites: 1×6, 2×12, 3×18, 4×24, 5×30, 6×36, Brelan/Carré/Chance 30, Full 25, Petite 30, Grande 40, Yam’s 50.</div>

  <!-- Settings Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="close-line"><button id="closeSettings" class="ghost-btn" aria-label="Fermer">✕</button></div>
    <h3 id="settingsTitle">Réglages</h3>
    <div>
      <strong>Thème</strong>
      <div class="radio-row"><input type="radio" name="themeMode" id="themeAuto" value="auto"><label for="themeAuto">Auto (suivre l’appareil)</label></div>
      <div class="radio-row"><input type="radio" name="themeMode" id="themeLight" value="light"><label for="themeLight">Clair</label></div>
      <div class="radio-row"><input type="radio" name="themeMode" id="themeDark" value="dark"><label for="themeDark">Sombre</label></div>
    </div>
    <div class="actions">
      <button id="exportBtn">Exporter</button>
      <button id="importBtn">Importer</button>
      <input id="importFile" class="hidden-input" type="file" accept="application/json" />
    </div>
  </div>

<script>
(function(){
  const CATS_UPPER = [
    {key:'ones',   label:'1 ×', hint:'Somme des 1', max:6},
    {key:'twos',   label:'2 ×', hint:'Somme des 2', max:12},
    {key:'threes', label:'3 ×', hint:'Somme des 3', max:18},
    {key:'fours',  label:'4 ×', hint:'Somme des 4', max:24},
    {key:'fives',  label:'5 ×', hint:'Somme des 5', max:30},
    {key:'sixes',  label:'6 ×', hint:'Somme des 6', max:36},
  ];
  const CATS_LOWER = [
    {key:'threeKind', label:'Brelan',        hint:'Somme des dés', max:30},
    {key:'fourKind',  label:'Carré',         hint:'Somme des dés', max:30},
    {key:'fullHouse', label:'Full',          hint:'25 pts',        max:25},
    {key:'smallStr',  label:'Petite suite',  hint:'30 pts',        max:30},
    {key:'largeStr',  label:'Grande suite',  hint:'40 pts',        max:40},
    {key:'yahtzee',   label:'Yam’s',         hint:'50 pts',        max:50},
    {key:'chance',    label:'Chance',        hint:'Somme des dés', max:30},
  ];
  const ALL_CATS = [...CATS_UPPER, ...CATS_LOWER];
  const STORAGE_KEY = "yams-app-pages-v4";
  const THEME_KEY = "yams-theme-mode"; // 'auto' | 'light' | 'dark'

  /** Theme handling **/
  const mql = window.matchMedia("(prefers-color-scheme: dark)");
  function applyTheme(mode){
    let theme = mode;
    if (mode === "auto"){ theme = mql.matches ? "dark" : "light"; }
    document.documentElement.setAttribute("data-theme", theme);
    const id = mode === "auto" ? "themeAuto" : (mode === "dark" ? "themeDark" : "themeLight");
    const el = document.getElementById(id); if (el) el.checked = true;
  }
  function initTheme(){
    let mode = localStorage.getItem(THEME_KEY) || "auto";
    applyTheme(mode);
    mql.addEventListener && mql.addEventListener("change", ()=>{
      if ((localStorage.getItem(THEME_KEY) || "auto") === "auto"){ applyTheme("auto"); }
    });
  }
  initTheme();

  // State
  let state = loadState() || { players: [] };
  function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }
  function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }

  function canonicalName(name){ return (name || "").trim().toLowerCase(); }
  function nameExists(name, exceptId=null){
    const cn = canonicalName(name);
    return state.players.some(p => canonicalName(p.name) === cn && p.id !== exceptId);
  }

  function newPlayer(name){
    const scores = {}; ALL_CATS.forEach(c => scores[c.key] = "");
    return { id: crypto.randomUUID(), name, scores };
  }

  const playersEl = document.getElementById("players");

  function num(v){ const n = Number(v); return isFinite(n) ? n : 0; }
  function sumUpper(scores){ return CATS_UPPER.reduce((s,c)=> s + num(scores[c.key]||0), 0); }
  function sumLower(scores){ return CATS_LOWER.reduce((s,c)=> s + num(scores[c.key]||0), 0); }
  function bonus(upper){ return upper >= 63 ? 35 : 0; }
  function totals(scores){
    const u = sumUpper(scores), b = bonus(u), l = sumLower(scores);
    return { upper:u, bonus:b, lower:l, total:u + b + l };
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
  }

  function buildPlayerCard(player){
    const wrap = document.createElement("div"); wrap.className = "card"; wrap.dataset.playerId = player.id;
    const head = document.createElement("header");
    head.innerHTML = `
      <div class="name">${escapeHtml(player.name || "Sans nom")}</div>
      <div class="row-actions">
        <span class="pill notice">Total: <span class="val-total">0</span></span>
        <button data-action="rename">Renommer</button>
        <button class="danger" data-action="delete">Supprimer</button>
      </div>`;
    wrap.appendChild(head);

    const table = document.createElement("table");
    const thead = document.createElement("thead"); thead.innerHTML = `<tr><th>Catégorie</th><th style="text-align:right">Score</th></tr>`; table.appendChild(thead);
    const tbody = document.createElement("tbody");

    CATS_UPPER.forEach(cat => tbody.appendChild(rowForCat(player, cat)));
    const trU = document.createElement("tr"); trU.innerHTML = `<td class="muted">Sous-total (1→6)</td><td style="text-align:right" class="muted"><span class="val-upper">0</span></td>`; tbody.appendChild(trU);
    const trB = document.createElement("tr"); trB.innerHTML = `<td class="muted">Bonus (≥63)</td><td style="text-align:right" class="muted"><span class="val-bonus">0</span></td>`; tbody.appendChild(trB);
    CATS_LOWER.forEach(cat => tbody.appendChild(rowForCat(player, cat)));
    const trT = document.createElement("tr"); trT.innerHTML = `<td class="total">Total</td><td style="text-align:right" class="total"><span class="val-total">0</span></td>`; tbody.appendChild(trT);

    table.appendChild(tbody); wrap.appendChild(table);

    head.querySelector('[data-action="rename"]').addEventListener('click', ()=>{
      const current = player.name || "";
      const newName = prompt("Nouveau nom du joueur :", current);
      if (newName !== null){
        const trimmed = newName.trim();
        if (!trimmed){ alert("Le nom ne peut pas être vide."); return; }
        if (nameExists(trimmed, player.id)){ alert("Ce prénom existe déjà. Choisissez un autre nom."); return; }
        player.name = trimmed;
        head.querySelector(".name").textContent = player.name;
        saveState(); renderLeaderboard();
      }
    });
    head.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
      if (confirm(`Supprimer ${player.name || "ce joueur"} ?`)){
        state.players = state.players.filter(pl => pl.id !== player.id);
        saveState();
        renderAllPlayers(); renderLeaderboard();
      }
    });

    refreshPlayerComputedFields(player, wrap);
    return wrap;
  }

  function rowForCat(player, cat){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="padding-right:12px">${cat.label} <span class="muted">(${cat.hint})</span></td>`;
    const td = document.createElement("td"); td.style.textAlign = "right";
    const input = document.createElement("input");
    input.type = "number"; input.inputMode = "numeric"; input.pattern = "[0-9]*";
    input.placeholder = `0…${cat.max}`; input.min = "0"; input.step = "1"; input.title = `Score max: ${cat.max}`;
    input.value = player.scores[cat.key];
    input.addEventListener("keydown", (e)=>{ if (e.key === "ArrowUp" || e.key === "ArrowDown"){ e.preventDefault(); } });
    input.addEventListener("input", ()=>{
      const raw = input.value.replace(/[^\d]/g, "");
      const v = raw === "" ? "" : clampInt(raw, 0, cat.max);
      if (String(v) != input.value){ input.value = v; }
      player.scores[cat.key] = raw === "" ? "" : v;
      saveState();
      const card = input.closest(".card");
      refreshPlayerComputedFields(player, card);
      renderLeaderboard();
    });
    td.appendChild(input); tr.appendChild(td);
    return tr;
  }

  function clampInt(v, min, max){
    let n = parseInt(v, 10);
    if (!isFinite(n)) n = 0;
    if (n < min) n = min;
    if (n > max) n = max;
    return n;
  }

  function refreshPlayerComputedFields(player, cardEl){
    const t = totals(player.scores);
    const headBadge = cardEl.querySelector("header .val-total"); if (headBadge) headBadge.textContent = t.total;
    const u = cardEl.querySelector(".val-upper"); if (u) u.textContent = t.upper;
    const b = cardEl.querySelector(".val-bonus"); if (b) b.textContent = t.bonus;
    const totalsInTable = cardEl.querySelectorAll("td .val-total"); totalsInTable.forEach(el => el.textContent = t.total);
  }

  function renderAllPlayers(){
    playersEl.innerHTML = "";
    state.players.forEach(p => playersEl.appendChild(buildPlayerCard(p)));
  }

  function renderLeaderboard(){
    const rowsEl = document.getElementById("rankingRows");
    const data = state.players.map(p => ({ id:p.id, name:p.name||"Sans nom", total: totals(p.scores).total })).sort((a,b)=> b.total - a.total);
    rowsEl.innerHTML = "";
    data.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className = "rank-row";
      div.innerHTML = `<div class="rank-badge">${idx+1}</div><div>${escapeHtml(r.name)}</div><div style="text-align:right; font-weight:800">${r.total}</div>`;
      rowsEl.appendChild(div);
    });
    document.getElementById("leaderboardHint").textContent =
      state.players.length ? "Classement mis à jour à chaque saisie." : "Ajoutez au moins un joueur pour démarrer.";
  }

  // Toolbar actions
  document.getElementById("addPlayerBtn").addEventListener('click', ()=>{
    const nameInput = document.getElementById("playerName");
    const name = (nameInput.value || "").trim();
    if (!name){ alert("Entrez un nom de joueur."); nameInput.focus(); return; }
    if (nameExists(name)){ alert("Ce prénom existe déjà. Choisissez un autre nom."); return; }
    const p = newPlayer(name);
    state.players.push(p);
    saveState();
    playersEl.appendChild(buildPlayerCard(p));
    renderLeaderboard();
    nameInput.value = "";
  });

  document.getElementById("playerName").addEventListener('keydown', (e)=>{
    if (e.key === "Enter") document.getElementById("addPlayerBtn").click();
  });
  document.getElementById("resetAllBtn").addEventListener('click', ()=>{
    if (!state.players.length) return;
    if (confirm("Effacer toutes les feuilles de score ?")){
      state = { players: [] };
      saveState();
      renderAllPlayers();
      renderLeaderboard();
    }
  });

  // Settings modal behavior
  const settingsBtn = document.getElementById("settingsBtn");
  const backdrop = document.getElementById("backdrop");
  const modal = document.getElementById("settingsModal");
  const closeSettings = document.getElementById("closeSettings");

  function openSettings(){
    backdrop.classList.add("open");
    modal.classList.add("open");
  }
  function closeSettingsModal(){
    backdrop.classList.remove("open");
    modal.classList.remove("open");
  }
  settingsBtn.addEventListener("click", openSettings);
  closeSettings.addEventListener("click", closeSettingsModal);
  backdrop.addEventListener("click", closeSettingsModal);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeSettingsModal(); });

  // Theme radio in modal
  document.querySelectorAll('input[name="themeMode"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      const mode = r.value;
      try{ localStorage.setItem(THEME_KEY, mode); }catch(e){}
      applyTheme(mode);
    });
  });

  // Export / Import (now in modal)
  document.getElementById("exportBtn").addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "yams-scores.json";
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
  });
  const importFile = document.getElementById("importFile");
  document.getElementById("importBtn").addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', ()=>{
    const file = importFile.files && importFile.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(String(reader.result));
        if (!data || !Array.isArray(data.players)) throw new Error("Format invalide");
        state = data; saveState();
        renderAllPlayers(); renderLeaderboard();
      }catch(err){ alert("Fichier invalide : " + err.message); }
    };
    reader.readAsText(file);
  });

  // First paint
  renderAllPlayers();
  renderLeaderboard();

  // PWA SW (versioned filename to force update)
  if ("serviceWorker" in navigator){
    window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw-v3.js"));
  }
})();
</script>
</body>
</html>
